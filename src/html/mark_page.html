<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/styleguide.css" />
    <link rel="stylesheet" href="../css/style_mark.css" />
    <script src="../js/chronometer.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const timeDisplay = document.querySelector('.text-rectangle-noir');
        let timeString = "00 : 00"; // D√©finir timeString dans le scope global du script
        
        if (timeDisplay) {
          const elapsedTime = parseInt(localStorage.getItem('elapsedTime')) || 0;
          const seconds = Math.floor((elapsedTime / 1000) % 60);
          const minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
          timeString = `${minutes.toString().padStart(2, '0')} : ${seconds.toString().padStart(2, '0')}`;
          timeDisplay.innerHTML = `Temps Total<br />${timeString}`;
        }
        
        // R√©cup√©ration et affichage des temps des sessions
        console.log('=== PAGE MARK - R√âCUP√âRATION DES TEMPS ===');
        
        // Debug: Afficher toutes les cl√©s localStorage
        console.log('üîç DEBUG - TOUTES LES CL√âS LOCALSTORAGE:');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          console.log(`${key}: ${value}`);
        }
        
        // R√©cup√©rer les temps stock√©s dans le localStorage
        const fourTime = parseInt(localStorage.getItem('fourTime') || '0');
        const twoTime = parseInt(localStorage.getItem('twoTime') || '0');
        const sixTime = parseInt(localStorage.getItem('sixTime') || '0');
        
        // R√©cup√©rer les temps format√©s des sessions
        const session1Time = localStorage.getItem('session1Time') || '0';
        const session2Time = localStorage.getItem('session2Time') || '0';
        const session3Time = localStorage.getItem('session3Time') || '0';
        
        // R√©cup√©rer le nombre de tirs
        const nombreTirs = parseInt(localStorage.getItem('nombreTirs') || '0');
        
        // R√©cup√©rer le nombre de sessions de tir
        const shootingSessions = parseInt(localStorage.getItem('shootingSessions') || '0');
        
        console.log('üìä TEMPS DES SESSIONS (format√©):');
        console.log('Session 1 (400m):', session1Time);
        console.log('Session 2 (200m):', session2Time);
        console.log('Session 3 (600m):', session3Time);
        
        console.log('‚è±Ô∏è TEMPS CONVERTIS (en secondes):');
        console.log('fourTime (400m):', fourTime, 'secondes');
        console.log('twoTime (200m):', twoTime, 'secondes');
        console.log('sixTime (600m):', sixTime, 'secondes');
        
        console.log('üéØ AUTRES DONN√âES:');
        console.log('Nombre de tirs:', nombreTirs);
        console.log('Nombre de sessions de tir:', shootingSessions);
        console.log('Temps total:', timeString);
        
        // V√©rification des valeurs
        console.log('‚úÖ V√âRIFICATION:');
        if (fourTime > 0) {
          console.log('‚úÖ fourTime (400m) r√©cup√©r√©:', fourTime, 'secondes');
        } else {
          console.log('‚ùå fourTime (400m) est √† 0');
        }
        
        if (twoTime > 0) {
          console.log('‚úÖ twoTime (200m) r√©cup√©r√©:', twoTime, 'secondes');
        } else {
          console.log('‚ùå twoTime (200m) est √† 0');
        }
        
        if (sixTime > 0) {
          console.log('‚úÖ sixTime (600m) r√©cup√©r√©:', sixTime, 'secondes');
        } else {
          console.log('‚ùå sixTime (600m) est √† 0');
        }
        
        // Calcul du temps total des 3 sessions
        const totalSessionTime = fourTime + twoTime + sixTime;
        console.log('üìà TEMPS TOTAL DES 3 SESSIONS:', totalSessionTime, 'secondes');
        
        // Conversion en format MM:SS
        const totalMinutes = Math.floor(totalSessionTime / 60);
        const totalSeconds = totalSessionTime % 60;
        const totalFormatted = `${totalMinutes.toString().padStart(2, '0')}:${totalSeconds.toString().padStart(2, '0')}`;
        console.log('üìà TEMPS TOTAL FORMAT√â:', totalFormatted);
        
        console.log('==========================================');
        
        // Pr√©paration pour l'API
        console.log('üöÄ DONN√âES PR√äTES POUR L\'API:');
        console.log({
          fourTime: fourTime,
          twoTime: twoTime,
          sixTime: sixTime,
          nbTirs: nombreTirs,
          totalTime: totalSessionTime
        });
        sendSessionDataToAPI(fourTime, twoTime, sixTime, nombreTirs);
      });


      function sendSessionDataToAPI(fourTime, twoTime, sixTime, nombreTirs) {
        const idUser = localStorage.getItem('userId');
        const meneur = localStorage.getItem('meneur') === 'true' ? 1 : 0;
        
        const url = 'https://172.16.100.3/api/sessions/create.php';
        $.ajax({
          type: 'GET',
          url: url,
          dataType: 'json',
          data: { 
            id_user: idUser,
            six: sixTime,
            quatre: fourTime,
            deux: twoTime,
            nb_tirs: nombreTirs,
            meneur: meneur
          },
          success: function(response) {
            console.log('R√©ponse de l\'API:', response);
            if (response.message) {
              console.log('Message:', response.message);
            }
          },
          error: function(xhr, status, error) {
            console.error('Erreur lors de la cr√©ation de la session de tir:');
            console.error('Status:', status);
            console.error('Error:', error);
          }
        });
      }
    </script>
  </head>
  <body>
    <div class="home-page">
      <div class="div">
        <div class="rectangle-noir">
            <a href="settings_page.html" class="button_settings">
                <img class="parametres" src="../img/parametres.png" alt="Param√®tres" /></a>
          <div class="text-rectangle-noir">
            <div class="text-rectangle-noir" id="temps_total">Temps Total<br />00 : 00</div>
          </div>
        </div>
        <div class="rectangle-vert">
            <div class="resultat-tir" id="resultat_tir">R√©sultat tirs XX%</div>
        </div>
      <div class="resultat-note" id="resultat_note">Vous avez obtenu <br> la note de 16/20</div>
       <a href="statistic_page.html" class="statistique-wrapper">
                <img class="img" src="../img/parametres.png" alt="Statistiques" /></a>
        
        <a href="statistic_page.html" class="button-wrapper">
        <div class="statistique-wrapper">
          <img class="img" src="../img/statistique.png" />
        </div>
        </a>

        <a href="index.html" class="button-wrapper">
        <div class="accueil-wrapper">
          <img class="img" src="../img/accueil.png" />
        </div>
        </a>

        <a href="history_page.html" class="button-wrapper">
        <div class="historique-wrapper">
          <img class="img" src="../img/historique.png" />
        </div>
        </a>
    </div>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/auth-check.js"></script>
  </body>
  <script src="../js/langue.js" ></script>
</html>